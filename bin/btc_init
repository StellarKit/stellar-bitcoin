#!/bin/bash

set -ex

# This shouldn't be in the Dockerfile or containers built from the same image
# will have the same credentials.
mkdir -p $HOME/.bitcoin

echo "Creating bitcoin.conf"

# Seed a random password for JSON RPC server
cat <<EOF > $HOME/.bitcoin/bitcoin.conf
prune=${PRUNE:-0}
testnet=${TESTNET:-1}
regtest=${REGTEST:-1}
disablewallet=${DISABLEWALLET:-1}
printtoconsole=${PRINTTOCONSOLE:-1}
rpcuser=${RPCUSER:-bitcoinrpc}
rpcpassword=${RPCPASSWORD:-`dd if=/dev/urandom bs=33 count=1 2>/dev/null | base64`}
EOF

[[ -n $WALLETNOTIFY ]] && echo "walletnotify=${WALLETNOTIFY}" >> $HOME/.bitcoin/bitcoin.conf
[[ -n $BLOCKNOTIFY ]] && echo "blocknotify=${BLOCKNOTIFY}" >> $HOME/.bitcoin/bitcoin.conf
[[ -n $ZMQPUBHASHTX ]] && echo "zmqpubhashtx=${ZMQPUBHASHTX}" >> $HOME/.bitcoin/bitcoin.conf
[[ -n $ZMQPUBHASHBLOCK ]] && echo "zmqpubhashblock=${ZMQPUBHASHBLOCK}" >> $HOME/.bitcoin/bitcoin.conf
[[ -n $ZMQPUBRAWBLOCK ]] && echo "zmqpubrawblock=${ZMQPUBRAWBLOCK}" >> $HOME/.bitcoin/bitcoin.conf
[[ -n $ZMQPUBRAWTX ]] && echo "zmqpubrawtx=${ZMQPUBRAWTX}" >> $HOME/.bitcoin/bitcoin.conf

cat $HOME/.bitcoin/bitcoin.conf

echo "Initialization completed successfully"
